<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Librer√≠a Matita - Sistema Integral</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&family=Playfair+Display:ital,wght@0,700;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root { 
            --verde-oscuro: #0a3d31; --verde-medio: #1a4d3e; --dorado: #c5a35d; 
            --crema: #f9f7f2; --blanco: #ffffff; --rojo: #e74c3c;
            --verde-whatsapp: #25d366; --naranja: #e67e22; --azul-pago: #3498db;
            --shadow: 0 12px 40px rgba(0,0,0,0.12);
        }
        
        * { box-sizing: border-box; transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1); outline: none; }
        
        body { 
            margin: 0; font-family: 'Montserrat', sans-serif; 
            background-color: var(--crema); color: #2c3e50; 
            overflow-x: hidden; padding-bottom: 100px;
            scroll-behavior: smooth;
        }

        /* --- UI COMPONENTS --- */
        .promo-banner {
            background: var(--naranja); color: white; text-align: center;
            padding: 12px; font-size: 0.85rem; font-weight: 700; 
            text-transform: uppercase; letter-spacing: 1.5px;
            position: sticky; top: 0; z-index: 1100;
        }

        header { 
            background: linear-gradient(135deg, var(--verde-oscuro) 0%, var(--verde-medio) 100%); 
            color: var(--blanco); padding: 50px 20px; text-align: center;
            border-bottom: 6px solid var(--dorado);
        }
        header h1 { font-family: 'Playfair Display', serif; font-size: clamp(2.5rem, 10vw, 4.5rem); margin: 0; }

        nav { 
            background: white; padding: 18px; position: sticky; top: 43px; z-index: 1050; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.08); display: flex; 
            justify-content: center; gap: clamp(10px, 4vw, 30px);
        }
        nav a { text-decoration: none; color: var(--verde-oscuro); font-weight: 700; font-size: 0.8rem; text-transform: uppercase; }
        nav a:hover { color: var(--dorado); }

        .container { max-width: 1200px; margin: 0 auto; padding: 25px; }

        /* --- ADMIN PANEL --- */
        .admin-panel {
            background: white; border-radius: 30px; padding: 35px;
            box-shadow: var(--shadow); margin-bottom: 50px; border: 1px solid rgba(0,0,0,0.05);
        }
        .admin-panel h2 { font-family: 'Playfair Display'; font-size: 2rem; color: var(--verde-oscuro); margin-top: 0; }
        
        .form-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px; margin-bottom: 25px;
        }
        
        label { display: block; font-size: 0.75rem; font-weight: 700; margin-bottom: 8px; color: #7f8c8d; text-transform: uppercase; }
        input, select { 
            width: 100%; padding: 15px; border: 2px solid #f1f3f5; 
            border-radius: 15px; font-family: 'Montserrat'; font-size: 1rem;
            background: #f8f9fa;
        }
        input:focus { border-color: var(--dorado); background: white; }

        .upload-container {
            border: 3px dashed #dee2e6; border-radius: 20px; padding: 40px;
            text-align: center; cursor: pointer; background: #fff;
            position: relative; overflow: hidden;
        }
        .upload-container:hover { border-color: var(--dorado); background: #fffdf9; }
        .preview-box { max-width: 200px; margin: 15px auto; border-radius: 15px; display: none; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }

        .btn-publish {
            width: 100%; background: var(--verde-oscuro); color: white;
            border: none; padding: 22px; border-radius: 18px; font-weight: 700;
            font-size: 1.1rem; cursor: pointer; letter-spacing: 1px;
            box-shadow: 0 8px 25px rgba(10, 61, 49, 0.2);
        }
        .btn-publish:active { transform: scale(0.98); }

        /* --- CATALOGO UI --- */
        .search-wrapper { margin: 40px 0; }
        .search-bar { width: 100%; padding: 20px 30px; border-radius: 50px; border: none; box-shadow: var(--shadow); font-size: 1.1rem; }

        .filter-scroll {
            display: flex; gap: 15px; overflow-x: auto; padding: 10px 5px 30px;
            scrollbar-width: none;
        }
        .filter-scroll::-webkit-scrollbar { display: none; }
        .filter-chip {
            min-width: 120px; padding: 18px; background: white; border-radius: 22px;
            text-align: center; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border: 2px solid transparent; flex-shrink: 0; font-weight: 600;
        }
        .filter-chip.active { background: var(--verde-oscuro); color: white; transform: translateY(-3px); }

        .products-grid { 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 30px; 
        }

        .card { 
            background: white; border-radius: 28px; overflow: hidden; 
            display: flex; flex-direction: column; position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.03);
        }
        .card:hover { transform: translateY(-10px); box-shadow: var(--shadow); }
        
        .card-img { 
            height: 300px; padding: 30px; background: #fbfbfb; 
            display: flex; align-items: center; justify-content: center; position: relative;
        }
        .card-img img { max-width: 100%; max-height: 100%; object-fit: contain; }
        
        .fav-btn {
            position: absolute; top: 20px; right: 20px; background: white;
            border: none; width: 45px; height: 45px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); color: #ddd; cursor: pointer; z-index: 5;
        }
        .fav-btn.active { color: var(--rojo); }

        .card-body { padding: 25px; text-align: center; flex-grow: 1; }
        .card-body h3 { margin: 10px 0; font-size: 1.25rem; color: var(--verde-oscuro); min-height: 3rem; }
        .card-price { font-size: 1.8rem; font-weight: 700; margin: 15px 0; color: #2c3e50; }

        .btn-buy {
            width: 100%; background: #f8f9fa; border: none; padding: 18px;
            font-weight: 700; color: var(--verde-oscuro); cursor: pointer;
            border-top: 1px solid #eee;
        }
        .btn-buy:hover { background: var(--verde-oscuro); color: white; }

        /* --- CARRITO MOBILE OPTIMIZED --- */
        .cart-overlay {
            position: fixed; bottom: 0; left: 50%; transform: translateX(-50%) translateY(105%);
            width: 100%; max-width: 600px; background: white; z-index: 2000;
            border-radius: 40px 40px 0 0; padding: 35px; box-shadow: 0 -20px 60px rgba(0,0,0,0.3);
            max-height: 90vh; overflow-y: auto;
        }
        .cart-overlay.active { transform: translateX(-50%) translateY(0); }

        .cart-item { display: flex; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid #f1f3f5; }

        .payment-selector { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 25px 0; }
        .pay-method {
            padding: 15px; border: 2px solid #f1f3f5; border-radius: 15px;
            text-align: center; font-size: 0.85rem; font-weight: 700; cursor: pointer;
        }
        .pay-method.selected { border-color: var(--azul-pago); background: #ebf5ff; color: var(--azul-pago); }

        .btn-finish {
            width: 100%; background: var(--verde-whatsapp); color: white;
            border: none; padding: 20px; border-radius: 20px; font-weight: 700;
            font-size: 1.2rem; cursor: pointer; margin-top: 20px;
        }

        /* --- RESPONSIVE ADJUSTMENTS --- */
        @media (max-width: 600px) {
            header { padding: 40px 15px; }
            .products-grid { grid-template-columns: 1fr; }
            .admin-panel { padding: 20px; border-radius: 20px; }
            .cart-overlay { padding: 25px 20px; }
        }
    </style>
</head>
<body>

<div class="promo-banner" id="promoMsg">¬°Regalo especial en compras mayores a $50.000!</div>

<header>
    <h1>Librer√≠a Matita</h1>
</header>

<nav>
    <a href="#catalogo">Cat√°logo</a>
    <a href="#admin">Publicar</a>
    <a href="favorito.html">Favoritos ‚ù§Ô∏è</a>
</nav>

<div class="container">
    
    <section id="admin" class="admin-panel">
        <h2><i class="fas fa-magic"></i> Panel de Carga</h2>
        <div class="form-grid">
            <div>
                <label>Nombre del Producto</label>
                <input type="text" id="pNombre" placeholder="Ej: Kit de Geometr√≠a">
            </div>
            <div>
                <label>Precio de Venta</label>
                <input type="number" id="pPrecio" placeholder="$ 0.00">
            </div>
            <div>
                <label>Categor√≠a</label>
                <select id="pCat">
                    <option value="lengua">Lengua</option>
                    <option value="matematica">Matem√°tica</option>
                    <option value="ciencias">Ciencias</option>
                    <option value="otros">Otros</option>
                </select>
            </div>
            <div>
                <label>Etiqueta</label>
                <select id="pTag">
                    <option value="ninguna">Sin Etiqueta</option>
                    <option value="Oferta">Oferta üî•</option>
                    <option value="Nuevo">Nuevo ‚ú®</option>
                    <option value="Combo">Combo üéÅ</option>
                </select>
            </div>
        </div>

        <div class="upload-container" onclick="document.getElementById('fileInp').click()">
            <i class="fas fa-camera-retro fa-3x" style="color:var(--dorado)"></i>
            <p id="upLabel" style="margin-top:15px; font-weight:600;">Subir foto desde Galer√≠a o C√°mara</p>
            <img id="pPreview" class="preview-box">
            <input type="file" id="fileInp" hidden accept="image/*" onchange="handleUpload(this.files[0])">
            <input type="hidden" id="pImgUrl">
        </div>

        <button class="btn-publish" onclick="submitToDB()" style="margin-top:30px;">
            <i class="fas fa-check-circle"></i> PUBLICAR EN LA WEB
        </button>
    </section>

    <section id="catalogo">
        <input type="text" class="search-bar" id="buscador" placeholder="Busca libros, packs o √∫tiles..." oninput="filtrar()">

        <div class="filter-scroll">
            <div class="filter-chip active" onclick="setCat('all', this)">Todos</div>
            <div class="filter-chip" onclick="setCat('lengua', this)">Lengua</div>
            <div class="filter-chip" onclick="setCat('matematica', this)">Matem√°tica</div>
            <div class="filter-chip" onclick="setCat('ciencias', this)">Ciencias</div>
            <div class="filter-chip" onclick="setCat('otros', this)">Otros</div>
        </div>

        <div class="products-grid" id="mainGrid">
            </div>
    </section>
</div>

<div id="cartUI" class="cart-overlay">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px;">
        <h2 style="margin:0; font-family:'Playfair Display';">Tu Carrito</h2>
        <i class="fas fa-times-circle" onclick="toggleCart(false)" style="font-size:2rem; color:#ccc; cursor:pointer;"></i>
    </div>

    <div id="cartItemsList"></div>

    <div class="payment-selector">
        <div class="pay-method selected" onclick="setPay('Efectivo', this)">Efectivo (-10%)</div>
        <div class="pay-method" onclick="setPay('Transferencia', this)">Transferencia</div>
    </div>

    <div style="background:#f8f9fa; padding:25px; border-radius:25px; margin:20px 0;">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
            <span>Subtotal:</span> <span id="resSub">$0</span>
        </div>
        <div id="descRow" style="display:none; justify-content:space-between; color:var(--rojo); font-weight:700; margin-bottom:10px;">
            <span>Descuento aplicado:</span> <span id="resDesc">-$0</span>
        </div>
        <div style="display:flex; justify-content:space-between; font-size:1.6rem; font-weight:700; color:var(--verde-oscuro); border-top:2px solid #dee2e6; padding-top:15px; margin-top:10px;">
            <span>TOTAL:</span> <span id="resTotal">$0</span>
        </div>
    </div>

    <button class="btn-finish" onclick="checkoutWA()">
        <i class="fab fa-whatsapp"></i> FINALIZAR POR WHATSAPP
    </button>
</div>

<script>
    // CONFIGURACION GLOBAL
    const CLOUD_NAME = "dllm8ggob"; 
    const UPLOAD_PRESET = "matita_preset"; 
    const SUPABASE_URL = "https://xlwkzoapfbpoxaccvoea.supabase.co";
    const SUPABASE_KEY = "sb_publishable_knGPyLLlMsy-YCQIblQnbQ_nrC8rV6x";
    
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let baseData = [];
    let cart = [];
    let favs = JSON.parse(localStorage.getItem('matita_favs')) || [];
    let currentCategory = 'all';
    let currentPay = 'Efectivo';

    // 1. MANEJO DE IMAGENES (CLOUDINARY)
    async function handleUpload(file) {
        if(!file) return;
        const label = document.getElementById('upLabel');
        const preview = document.getElementById('pPreview');
        label.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Subiendo imagen...`;

        const fd = new FormData();
        fd.append('file', file);
        fd.append('upload_preset', UPLOAD_PRESET);

        try {
            const resp = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, {
                method: 'POST', body: fd
            });
            const data = await resp.json();
            
            // Aplicamos optimizaci√≥n f_auto (formato) y q_auto (calidad)
            const urlFinal = data.secure_url.replace('/upload/', '/upload/f_auto,q_auto/');
            document.getElementById('pImgUrl').value = urlFinal;
            preview.src = urlFinal;
            preview.style.display = 'block';
            label.innerHTML = `¬°Imagen cargada! ‚úÖ`;
        } catch (e) {
            label.innerHTML = `Error al subir ‚ùå`;
            console.error(e);
        }
    }

    // 2. LOGICA DE BASE DE DATOS (SUPABASE)
    async function submitToDB() {
        const payload = {
            nombre: document.getElementById('pNombre').value,
            precio: Number(document.getElementById('pPrecio').value),
            categoria: document.getElementById('pCat').value,
            etiqueta: document.getElementById('pTag').value,
            imagen: document.getElementById('pImgUrl').value
        };

        if(!payload.nombre || !payload.precio || !payload.imagen) {
            return alert("Por favor, completa nombre, precio y foto.");
        }

        const { error } = await _supabase.from('productos').insert([payload]);
        if(error) alert("Error: " + error.message);
        else {
            alert("¬°Publicado con √©xito!");
            location.reload();
        }
    }

    async function fetchData() {
        const { data } = await _supabase.from('productos').select('*').order('created_at', { ascending: false });
        baseData = data || [];
        render();
    }

    // 3. RENDERIZADO Y FILTROS
    function render() {
        const grid = document.getElementById('mainGrid');
        const term = document.getElementById('buscador').value.toLowerCase();
        
        const filtered = baseData.filter(p => {
            const matchCat = currentCategory === 'all' || p.categoria === currentCategory;
            const matchSearch = p.nombre.toLowerCase().includes(term);
            return matchCat && matchSearch;
        });

        grid.innerHTML = filtered.map(p => `
            <div class="card">
                <button class="fav-btn ${favs.includes(p.nombre) ? 'active' : ''}" onclick="toggleFav('${p.nombre}')">
                    <i class="fas fa-heart"></i>
                </button>
                <div class="card-img">
                    ${p.etiqueta !== 'ninguna' ? `<span style="position:absolute; top:15px; left:15px; background:var(--dorado); color:white; padding:6px 15px; border-radius:50px; font-size:0.7rem; font-weight:700;">${p.etiqueta}</span>` : ''}
                    <img src="${p.imagen}" alt="${p.nombre}">
                </div>
                <div class="card-body">
                    <small style="color:var(--dorado); font-weight:700; text-transform:uppercase;">${p.categoria}</small>
                    <h3>${p.nombre}</h3>
                    <div class="card-price">$${p.precio.toLocaleString('es-AR')}</div>
                </div>
                <button class="btn-buy" onclick="addToCart('${p.nombre}', ${p.precio})">
                    <i class="fas fa-cart-plus"></i> SUMAR AL CARRITO
                </button>
            </div>
        `).join('');
    }

    // 4. CARRITO Y PAGOS
    function addToCart(name, price) {
        cart.push({name, price});
        updateCartUI();
        toggleCart(true);
    }

    function updateCartUI() {
        const list = document.getElementById('cartItemsList');
        let sub = cart.reduce((a, b) => a + b.price, 0);
        let disc = currentPay === 'Efectivo' ? sub * 0.10 : 0;
        let total = sub - disc;

        list.innerHTML = cart.map((item, i) => `
            <div class="cart-item">
                <span>${item.name}</span>
                <strong>$${item.price.toLocaleString()} <i class="fas fa-trash" onclick="drop(${i})" style="color:var(--rojo); margin-left:10px; cursor:pointer;"></i></strong>
            </div>
        `).join('');

        document.getElementById('resSub').innerText = `$${sub.toLocaleString('es-AR')}`;
        document.getElementById('resTotal').innerText = `$${total.toLocaleString('es-AR')}`;
        
        const row = document.getElementById('descRow');
        if(disc > 0) {
            row.style.display = 'flex';
            document.getElementById('resDesc').innerText = `-$${disc.toLocaleString('es-AR')}`;
        } else {
            row.style.display = 'none';
        }
    }

    function drop(i) {
        cart.splice(i, 1);
        updateCartUI();
        if(cart.length === 0) toggleCart(false);
    }

    function setPay(m, el) {
        currentPay = m;
        document.querySelectorAll('.pay-method').forEach(b => b.classList.remove('selected'));
        el.classList.add('selected');
        updateCartUI();
    }

    function toggleCart(s) {
        document.getElementById('cartUI').classList.toggle('active', s);
    }

    function checkoutWA() {
        if(cart.length === 0) return;
        const total = document.getElementById('resTotal').innerText;
        const lista = cart.map(item => `‚Ä¢ ${item.name}`).join('%0A');
        const url = `https://wa.me/3516062227?text=*NUEVO PEDIDO - LIBRER√çA MATITA*%0A%0A${lista}%0A%0A*Pago:* ${currentPay}%0A*Total Final:* ${total}`;
        window.open(url, '_blank');
    }

    // 5. UTILIDADES
    function setCat(c, el) {
        currentCategory = c;
        document.querySelectorAll('.filter-chip').forEach(x => x.classList.remove('active'));
        el.classList.add('active');
        render();
    }

    function toggleFav(name) {
        if(favs.includes(name)) favs = favs.filter(f => f !== name);
        else favs.push(name);
        localStorage.setItem('matita_favs', JSON.stringify(favs));
        render();
    }

    function filtrar() { render(); }

    window.onload = fetchData;
</script>
</body>
</html>
