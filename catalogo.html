<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Librer√≠a Matita - Cat√°logo Completo</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&family=Playfair+Display:ital,wght@0,700;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root { 
            --verde-oscuro: #0a3d31; 
            --verde-medio: #1a4d3e; 
            --dorado: #c5a35d; 
            --crema: #f9f7f2; 
            --blanco: #ffffff; 
            --rojo: #e74c3c;
            --verde-whatsapp: #25d366; 
            --naranja: #e67e22;
            --azul-pago: #3498db;
            --shadow: 0 10px 30px rgba(0,0,0,0.08);
        }
        
        * { box-sizing: border-box; transition: all 0.3s ease; }
        
        body { 
            margin: 0; 
            font-family: 'Montserrat', sans-serif; 
            background-color: var(--crema); 
            color: #333; 
            overflow-x: hidden; 
            padding-bottom: 120px; 
        }

        /* BANNER PROMOCIONAL */
        .promo-pack {
            background: var(--naranja); 
            color: white; 
            text-align: center;
            padding: 10px; 
            font-size: 0.8rem; 
            font-weight: 700; 
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            z-index: 1001;
        }

        /* HEADER & NAV */
        header { 
            background: linear-gradient(135deg, var(--verde-oscuro) 0%, var(--verde-medio) 100%); 
            color: var(--blanco); 
            padding: 60px 20px; 
            text-align: center;
            border-bottom: 5px solid var(--dorado);
        }
        header h1 { font-family: 'Playfair Display', serif; font-size: clamp(2.5rem, 8vw, 4rem); margin: 0; }

        nav { 
            background: white; 
            padding: 15px; 
            text-align: center; 
            position: sticky; 
            top: 0; 
            z-index: 1000; 
            box-shadow: 0 2px 15px rgba(0,0,0,0.1); 
            display: flex; 
            justify-content: center; 
            gap: 25px; 
            flex-wrap: wrap;
        }
        nav a { 
            text-decoration: none; 
            color: var(--verde-oscuro); 
            font-weight: 700; 
            font-size: 0.85rem; 
            text-transform: uppercase; 
            letter-spacing: 1px;
        }
        nav a:hover { color: var(--dorado); }

        .container { max-width: 1200px; margin: 0 auto; padding: 40px 20px; }

        /* CATEGOR√çAS */
        .category-container {
            display: flex; 
            justify-content: center; 
            gap: 15px; 
            overflow-x: auto;
            padding: 10px 5px 30px; 
            scrollbar-width: none;
        }
        .category-container::-webkit-scrollbar { display: none; }
        
        .cat-card { 
            min-width: 110px; 
            padding: 20px 15px; 
            background: white; 
            border-radius: 20px; 
            text-align: center; 
            cursor: pointer; 
            border: 2px solid transparent;
            box-shadow: var(--shadow); 
            flex-shrink: 0;
        }
        .cat-card.active { 
            border-color: var(--verde-oscuro); 
            background: var(--verde-oscuro); 
            color: white; 
            transform: translateY(-5px);
        }
        .cat-card i { font-size: 1.5rem; color: var(--dorado); margin-bottom: 8px; display: block; }
        .cat-card span { font-weight: 600; font-size: 0.9rem; }

        /* FILTROS Y BUSCADOR */
        .filters-wrapper { 
            background: white; 
            padding: 25px; 
            border-radius: 25px; 
            margin-bottom: 40px; 
            box-shadow: var(--shadow); 
        }
        .search-box { 
            width: 100%; 
            padding: 18px 25px; 
            border: 1px solid #eee; 
            border-radius: 50px; 
            outline: none; 
            font-family: 'Montserrat';
            font-size: 1rem;
            background: #fdfdfd;
        }

        /* GRID DE PRODUCTOS */
        .grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); 
            gap: 30px; 
        }

        .product-card { 
            background: white; 
            border-radius: 25px; 
            overflow: hidden; 
            position: relative; 
            border: 1px solid rgba(0,0,0,0.03);
            display: flex; 
            flex-direction: column;
            box-shadow: 0 5px 15px rgba(0,0,0,0.02);
        }
        .product-card:hover { transform: translateY(-10px); box-shadow: 0 15px 35px rgba(0,0,0,0.1); }

        .img-container { 
            height: 300px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            padding: 30px; 
            position: relative; 
            background: #fafafa;
        }
        .img-container img { max-width: 100%; max-height: 100%; object-fit: contain; }
        
        .fav-btn {
            position: absolute; top: 20px; right: 20px; 
            background: white; border: none; border-radius: 50%; 
            width: 45px; height: 45px; display: flex; 
            align-items: center; justify-content: center;
            cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.1); 
            color: #ddd; z-index: 10;
        }
        .fav-btn.active { color: var(--rojo); }

        .badge-promo { 
            position: absolute; top: 20px; left: 20px; 
            background: var(--dorado); color: white; 
            padding: 6px 15px; border-radius: 50px; 
            font-size: 0.75rem; font-weight: 700; 
        }

        .info { padding: 25px; text-align: center; flex-grow: 1; }
        .info h3 { margin: 15px 0; font-size: 1.2rem; min-height: 54px; font-weight: 600; color: var(--verde-oscuro); }
        
        .price-container { margin: 15px 0; min-height: 60px; }
        .price { font-size: 1.8rem; font-weight: 700; color: var(--verde-oscuro); margin: 0; }
        .old-price { font-size: 1rem; color: #999; text-decoration: line-through; display: block; }

        .btn-add { 
            width: 100%; 
            background: var(--verde-oscuro); 
            color: white; 
            border: none; 
            padding: 18px; 
            font-weight: 700; 
            cursor: pointer; 
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .btn-add:hover { background: var(--dorado); }

        /* CARRITO / RESUMEN */
        .cart-summary { 
            position: fixed; bottom: 0; left: 50%; 
            transform: translateX(-50%) translateY(105%); 
            background: white; padding: 35px; 
            border-radius: 40px 40px 0 0; 
            box-shadow: 0 -15px 50px rgba(0,0,0,0.2); 
            z-index: 2000; width: 100%; 
            max-width: 600px; max-height: 90vh; 
            overflow-y: auto;
        }
        .cart-summary.active { transform: translateX(-50%) translateY(0); }

        .cart-list { margin: 20px 0; padding: 0; list-style: none; }
        .cart-item { 
            display: flex; justify-content: space-between; 
            padding: 12px 0; border-bottom: 1px solid #eee; 
            font-size: 0.95rem; 
        }

        .payment-methods { margin: 25px 0; }
        .methods-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 10px; }
        .method-opt { 
            padding: 15px; border: 2.5px solid #eee; border-radius: 15px; 
            font-size: 0.85rem; cursor: pointer; text-align: center; 
            font-weight: 700; color: #666;
        }
        .method-opt.selected { 
            border-color: var(--azul-pago); 
            background: #f0f8ff; 
            color: var(--azul-pago); 
        }

        .coupon-box { display: flex; gap: 10px; margin-bottom: 20px; }
        .coupon-box input { 
            flex: 1; padding: 15px; border: 1px solid #ddd; 
            border-radius: 15px; font-family: 'Montserrat'; 
        }
        .btn-coupon { 
            background: var(--verde-oscuro); color: white; 
            border: none; padding: 0 25px; border-radius: 15px; 
            cursor: pointer; font-weight: 700; 
        }

        .totals-card { background: #f9f9f9; padding: 25px; border-radius: 20px; margin-bottom: 25px; }
        .total-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 1rem; }
        .total-main { font-size: 1.8rem; font-weight: 700; color: var(--verde-oscuro); border-top: 2px solid #ddd; padding-top: 15px; margin-top: 10px; }

        .whatsapp-float { 
            position: fixed; width: 65px; height: 65px; 
            bottom: 30px; right: 30px; background: #25d366; 
            color: white; border-radius: 50%; display: flex; 
            align-items: center; justify-content: center; 
            font-size: 35px; z-index: 1000; text-decoration: none; 
            box-shadow: 0 10px 25px rgba(37,211,102,0.3); 
        }

        @media (max-width: 600px) {
            header { padding: 40px 15px; }
            .grid { grid-template-columns: 1fr; }
            .cart-summary { padding: 25px 15px; border-radius: 25px 25px 0 0; }
        }
    </style>
</head>
<body>

<div class="promo-pack" id="promoBanner">Cargando beneficios...</div>

<header>
    <h1>Librer√≠a Matita</h1>
</header>

<nav>
    <a href="Inicio.html">Inicio</a>
    <a href="Favorito.html">Mis Favoritos ‚ù§Ô∏è</a>
    <a href="Contacto.html">Contacto</a>
</nav>

<div class="container">
    <div class="category-container" id="catBar">
        <div class="cat-card active" onclick="filterCat('all', this)"><i class="fas fa-th-large"></i><span>Todos</span></div>
        <div class="cat-card" onclick="filterCat('lengua', this)"><i class="fas fa-book"></i><span>Lengua</span></div>
        <div class="cat-card" onclick="filterCat('matematica', this)"><i class="fas fa-calculator"></i><span>Mate</span></div>
        <div class="cat-card" onclick="filterCat('ciencias', this)"><i class="fas fa-microscope"></i><span>Ciencias</span></div>
        <div class="cat-card" onclick="filterCat('otros', this)"><i class="fas fa-plus-circle"></i><span>Otros</span></div>
    </div>

    <div class="filters-wrapper">
        <input type="text" id="search" class="search-box" placeholder="¬øQu√© libro o material busc√°s hoy?" oninput="render()">
    </div>

    <div class="grid" id="productGrid">
        </div>
</div>

<div id="cartBar" class="cart-summary">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3 style="margin:0; font-family:'Playfair Display'; font-size:1.8rem;">Tu Carrito</h3>
        <i class="fas fa-times" onclick="toggleCart(false)" style="cursor:pointer; font-size:1.5rem;"></i>
    </div>
    
    <ul id="cartList" class="cart-list"></ul>
    
    <div class="coupon-box">
        <input type="text" id="couponInput" placeholder="C√≥digo de cup√≥n">
        <button class="btn-coupon" onclick="applyCoupon()">Validar</button>
    </div>

    <div class="payment-methods">
        <strong style="font-size:0.9rem; text-transform:uppercase; color:#888;">Eleg√≠ c√≥mo pagar:</strong>
        <div class="methods-grid">
            <div class="method-opt" onclick="selectPayment('Efectivo', this)">Efectivo (-10%)</div>
            <div class="method-opt" onclick="selectPayment('Transferencia', this)">Transferencia</div>
            <div class="method-opt" onclick="selectPayment('Mercado Pago', this)">Mercado Pago</div>
            <div class="method-opt" onclick="selectPayment('Tarjeta', this)">Tarjeta</div>
        </div>
    </div>

    <div class="totals-card">
        <div class="total-row"><span>Subtotal:</span> <span id="cartSubtotal">$0</span></div>
        <div id="discountRow" style="display:none; color: var(--rojo); font-weight:700;" class="total-row">
            <span id="discountLabel">Bonificaci√≥n:</span> <span id="cartDiscount">-$0</span>
        </div>
        <div class="total-row total-main">
            <span>TOTAL:</span>
            <span id="cartTotal">$0</span>
        </div>
    </div>

    <div style="display:flex; gap:15px;">
        <button onclick="vaciarCarrito()" style="flex:1; padding:20px; border:none; border-radius:15px; cursor:pointer; font-weight:700; background:#eee;">Limpiar</button>
        <button onclick="sendOrder()" style="flex:2; background:var(--verde-whatsapp); color:white; border:none; border-radius:15px; font-weight:700; cursor:pointer; font-size:1.1rem; display:flex; align-items:center; justify-content:center; gap:10px;">
            <i class="fab fa-whatsapp"></i> Finalizar Pedido
        </button>
    </div>
</div>

<a href="https://wa.me/3516062227" class="whatsapp-float" target="_blank"><i class="fab fa-whatsapp"></i></a>

<script>
    // --- CONFIGURACI√ìN DE DATOS ---
    const SUPABASE_URL = "https://xlwkzoapfbpoxaccvoea.supabase.co";
    const SUPABASE_KEY = "sb_publishable_knGPyLLlMsy-YCQIblQnbQ_nrC8rV6x";
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let products = [];
    let favorites = JSON.parse(localStorage.getItem('favoritos_matita')) || [];
    let cart = [];
    let currentCat = 'all';
    let appliedCoupon = null;
    let paymentMethod = "";

    const configMatita = { 
        montoMinimoRegalo: 50000, 
        valorRegalo: 5000,
        descEfectivo: 0.10 // 10% de descuento en efectivo
    };

    // --- CARGA DE PRODUCTOS ---
    async function loadProducts() {
        const { data, error } = await _supabase.from('productos').select('*');
        if (error) {
            console.error("Error:", error);
        } else {
            products = data;
            render();
        }
    }

    // --- RENDERIZADO ---
    function render() {
        const grid = document.getElementById('productGrid');
        const searchVal = document.getElementById('search').value.toLowerCase();
        grid.innerHTML = '';
        
        const filtered = products.filter(p => {
            const matchesSearch = p.nombre.toLowerCase().includes(searchVal);
            const matchesCat = (currentCat === 'all' || p.categoria === currentCat);
            return matchesSearch && matchesCat;
        });

        filtered.forEach(p => {
            const isFav = favorites.includes(p.nombre) ? 'active' : '';
            const imgUrl = p.imagen.includes('cloudinary') ? p.imagen.replace('/upload/', '/upload/f_auto,q_auto/') : p.imagen;
            
            grid.innerHTML += `
                <div class="product-card">
                    <div class="img-container">
                        ${p.etiqueta && p.etiqueta !== 'ninguna' ? `<div class="badge-promo">${p.etiqueta}</div>` : ''}
                        <button class="fav-btn ${isFav}" onclick="toggleFav('${p.nombre}')"><i class="fas fa-heart"></i></button>
                        <img src="${imgUrl}" onerror="this.src='https://via.placeholder.com/300'">
                    </div>
                    <div class="info">
                        <small style="color:var(--dorado); font-weight:700; text-transform:uppercase">${p.categoria}</small>
                        <h3>${p.nombre}</h3>
                        <div class="price-container">
                            ${p.precioAnterior ? `<span class="old-price">$${Number(p.precioAnterior).toLocaleString('es-AR')}</span>` : ''}
                            <p class="price">$${Number(p.precio).toLocaleString('es-AR')}</p>
                        </div>
                        <button class="btn-add" onclick="addToCart('${p.nombre}', ${p.precio})">Sumar al Carrito</button>
                    </div>
                </div>`;
        });
    }

    // --- L√ìGICA DEL CARRITO ---
    function addToCart(name, price) {
        cart.push({name, price});
        updateCartUI();
        toggleCart(true);
    }

    function toggleCart(show) {
        document.getElementById('cartBar').classList.toggle('active', show);
    }

    function selectPayment(method, el) {
        paymentMethod = method;
        document.querySelectorAll('.method-opt').forEach(opt => opt.classList.remove('selected'));
        el.classList.add('selected');
        updateCartUI();
    }

    function updateCartUI() {
        const list = document.getElementById('cartList');
        list.innerHTML = cart.map((item, index) => `
            <li class="cart-item">
                <span>${item.name}</span>
                <strong>$${item.price.toLocaleString('es-AR')} <i class="fas fa-trash-alt" onclick="removeItem(${index})" style="color:var(--rojo); margin-left:10px; cursor:pointer"></i></strong>
            </li>
        `).join('');

        let subtotal = cart.reduce((acc, item) => acc + item.price, 0);
        let descuentoEfectivo = (paymentMethod.includes('Efectivo')) ? subtotal * configMatita.descEfectivo : 0;
        let regaloExtra = (subtotal >= configMatita.montoMinimoRegalo) ? configMatita.valorRegalo : 0;
        let cup√≥nDesc = appliedCoupon ? subtotal * (appliedCoupon.descuento / 100) : 0;
        
        let totalDescuentos = descuentoEfectivo + regaloExtra + cup√≥nDesc;
        let totalFinal = subtotal - totalDescuentos;

        document.getElementById('cartSubtotal').innerText = `$${subtotal.toLocaleString('es-AR')}`;
        
        if(totalDescuentos > 0) {
            document.getElementById('discountRow').style.display = 'flex';
            document.getElementById('cartDiscount').innerText = `-$${totalDescuentos.toLocaleString('es-AR')}`;
        } else {
            document.getElementById('discountRow').style.display = 'none';
        }

        document.getElementById('cartTotal').innerText = `$${(totalFinal < 0 ? 0 : totalFinal).toLocaleString('es-AR')}`;
    }

    async function applyCoupon() {
        const input = document.getElementById('couponInput').value.trim().toUpperCase();
        const { data, error } = await _supabase.from('cupones').select('*').eq('codigo', input).single();
        if(data && !error) {
            appliedCoupon = data;
            alert("¬°Cup√≥n aplicado con √©xito!");
            updateCartUI();
        } else {
            alert("El cup√≥n no existe o expir√≥.");
        }
    }

    function removeItem(idx) {
        cart.splice(idx, 1);
        if(cart.length === 0) toggleCart(false);
        updateCartUI();
    }

    function vaciarCarrito() {
        cart = [];
        paymentMethod = "";
        appliedCoupon = null;
        document.querySelectorAll('.method-opt').forEach(opt => opt.classList.remove('selected'));
        toggleCart(false);
        updateCartUI();
    }

    // --- ENV√çO DE PEDIDO ---
    async function sendOrder() {
        if(cart.length === 0) return alert("El carrito est√° vac√≠o.");
        if(!paymentMethod) return alert("Por favor, seleccion√° un m√©todo de pago.");

        let subtotal = cart.reduce((acc, item) => acc + item.price, 0);
        let totalFinal = document.getElementById('cartTotal').innerText;

        let mensaje = `*NUEVO PEDIDO - LIBRER√çA MATITA*%0A%0A`;
        mensaje += cart.map(i => `‚Ä¢ ${i.name}`).join('%0A');
        mensaje += `%0A%0A*Pago:* ${paymentMethod}`;
        mensaje += `%0A*Total:* ${totalFinal}`;
        mensaje += `%0A%0A_Enviado desde la web_`;

        // Guardar pedido en base de datos (opcional)
        await _supabase.from('pedidos').insert([{
            detalle: cart.map(i => i.name).join(", "),
            total: subtotal,
            pago: paymentMethod
        }]);

        window.open(`https://wa.me/3516062227?text=${mensaje}`, '_blank');
    }

    // --- OTROS ---
    function filterCat(cat, el) {
        currentCat = cat;
        document.querySelectorAll('.cat-card').forEach(c => c.classList.remove('active'));
        el.classList.add('active');
        render();
    }

    function toggleFav(name) {
        favorites = favorites.includes(name) ? favorites.filter(f => f !== name) : [...favorites, name];
        localStorage.setItem('favoritos_matita', JSON.stringify(favorites));
        render();
    }

    window.onload = () => {
        document.getElementById('promoBanner').innerText = `üéÅ ¬°Regalo de $${configMatita.valorRegalo.toLocaleString()} en compras mayores a $${configMatita.montoMinimoRegalo.toLocaleString()}!`;
        loadProducts();
    };
</script>
</body>
</html>
