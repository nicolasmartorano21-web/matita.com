
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Librer√≠a Matita - Cat√°logo</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;500;700&family=Playfair+Display:ital,wght@0,700;1,400&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root { 
        --verde-oscuro: #0a3d31; 
        --verde-medio: #1a4d3e; 
        --dorado: #c5a35d; 
        --crema: #f9f7f2; 
        --blanco: #ffffff; 
        --rojo: #e74c3c;
        --verde-whatsapp: #25d366; 
        --naranja: #e67e22;
        --azul-pago: #3498db;
    }
    
    * { box-sizing: border-box; }
    body { margin: 0; font-family: 'Montserrat', sans-serif; background-color: var(--crema); color: #333; overflow-x: hidden; padding-bottom: 100px; }

    header { 
        background: linear-gradient(135deg, var(--verde-oscuro) 0%, var(--verde-medio) 100%); 
        color: var(--blanco); padding: 40px 20px; text-align: center; 
    }
    header h1 { font-family: 'Playfair Display', serif; font-size: clamp(2rem, 8vw, 3rem); margin: 0; }

    nav { 
        background: white; padding: 15px; text-align: center; position: sticky; 
        top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.05); 
        display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;
    }
    nav a { text-decoration: none; color: var(--verde-oscuro); font-weight: 700; font-size: 0.8rem; text-transform: uppercase; }

    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }

    /* ESTILO NUEVO: BOT√ìN DE SUBIDA */
    .admin-upload-zone {
        background: white; padding: 20px; border-radius: 20px; margin-bottom: 20px;
        text-align: center; border: 2px dashed var(--dorado);
    }

    .promo-pack {
        background: var(--naranja); color: white; text-align: center;
        padding: 8px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase;
    }

    .category-container {
        display: flex; justify-content: center; gap: 10px; overflow-x: auto;
        padding: 10px 0 20px; scrollbar-width: none;
    }
    .cat-card { 
        min-width: 90px; padding: 12px; background: white; border-radius: 12px; 
        text-align: center; cursor: pointer; transition: 0.3s; border: 2px solid transparent;
        box-shadow: 0 4px 8px rgba(0,0,0,0.05); flex-shrink: 0;
    }
    .cat-card.active { border-color: var(--verde-oscuro); background: var(--verde-oscuro); color: white; }
    .cat-card i { font-size: 1.2rem; color: var(--dorado); margin-bottom: 5px; display: block; }

    .filters-wrapper { 
        background: white; padding: 20px; border-radius: 20px; 
        margin-bottom: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); 
    }
    .search-box { width: 100%; padding: 15px; border: 1px solid #ddd; border-radius: 50px; outline: none; }

    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }

    .product-card { 
        background: white; border-radius: 20px; overflow: hidden; 
        position: relative; transition: 0.3s; border: 1px solid #eee;
        display: flex; flex-direction: column;
    }
    .img-container { height: 250px; display: flex; align-items: center; justify-content: center; padding: 20px; position: relative; }
    .img-container img { max-width: 100%; max-height: 100%; object-fit: contain; }
    
    .fav-btn {
        position: absolute; top: 15px; right: 15px; background: white;
        border: none; border-radius: 50%; width: 35px; height: 35px;
        display: flex; align-items: center; justify-content: center;
        cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1); color: #ccc;
    }
    .fav-btn.active { color: var(--rojo); }

    .info { padding: 20px; text-align: center; flex-grow: 1; }
    .price-container { margin: 10px 0; min-height: 50px; }
    .price { font-size: 1.6rem; font-weight: 700; color: var(--verde-oscuro); margin: 0; }
    .old-price { font-size: 0.9rem; color: #888; text-decoration: line-through; display: block; }
    .price-promo { color: var(--rojo); }

    .badge-promo { position: absolute; top: 10px; left: 10px; background: var(--dorado); color: white; padding: 5px 10px; border-radius: 5px; font-size: 0.7rem; font-weight: 700; }

    .btn-add { width: 100%; background: var(--verde-oscuro); color: white; border: none; padding: 15px; font-weight: 700; cursor: pointer; transition: 0.3s; }
    .btn-add:hover { background: var(--dorado); }

    /* CARRITO */
    .cart-summary { 
        position: fixed; bottom: 0; left: 50%; transform: translateX(-50%) translateY(105%); 
        background: white; padding: 25px; border-radius: 30px 30px 0 0; 
        box-shadow: 0 -15px 50px rgba(0,0,0,0.15); z-index: 2000; width: 100%; 
        max-width: 500px; transition: 0.5s; max-height: 90vh; overflow-y: auto;
    }
    .cart-summary.active { transform: translateX(-50%) translateY(0); }
    .cart-list { max-height: 150px; overflow-y: auto; margin-bottom: 15px; padding: 0; list-style: none; }
    .cart-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f0f0f0; font-size: 0.85rem; }

    .payment-methods { margin: 15px 0; padding: 10px; border: 1px solid #eee; border-radius: 15px; }
    .payment-methods h4 { margin: 0 0 10px 0; font-size: 0.8rem; color: #777; text-transform: uppercase; }
    .methods-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .method-opt { 
        padding: 10px; border: 1.5px solid #eee; border-radius: 10px; 
        font-size: 0.75rem; cursor: pointer; text-align: center; font-weight: 600; transition: 0.2s;
    }
    .method-opt.selected { border-color: var(--azul-pago); background: #ebf5fb; color: var(--azul-pago); }

    .coupon-box { display: flex; gap: 8px; margin-bottom: 15px; }
    .coupon-box input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-family: 'Montserrat'; }
    .btn-coupon { background: var(--verde-oscuro); color: white; border: none; padding: 0 15px; border-radius: 10px; cursor: pointer; font-weight: 700; }

    .whatsapp-float { position: fixed; width: 60px; height: 60px; bottom: 30px; right: 30px; background: #25d366; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; z-index: 1000; text-decoration: none; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
  </style>
</head>
<body>

<div class="promo-pack" id="promoBanner">üéÅ ¬°Promociones activas!</div>

<header><h1>Librer√≠a Matita</h1></header>

<nav>
  <a href="Inicio.html">Inicio</a>
  <a href="Favorito.html">Favoritos ‚ù§Ô∏è</a>
  <a href="Contacto.html">Contacto</a>
</nav>

<div class="container">
  
  <div class="admin-upload-zone">
    <p style="margin-top:0; font-weight:700; color:var(--verde-oscuro)">Subir Nuevo Libro</p>
    <input type="file" id="fileInput" accept="image/*" style="display: none;" onchange="handleFileUpload(event)">
    <button onclick="document.getElementById('fileInput').click()" style="background:var(--dorado); color:white; border:none; padding:10px 20px; border-radius:50px; cursor:pointer; font-weight:700;">
        <i class="fas fa-image"></i> Seleccionar de Galer√≠a
    </button>
    <div id="uploadStatus" style="margin-top:10px; font-size:0.8rem; font-weight:500;"></div>
  </div>

  <div class="category-container">
    <div class="cat-card active" onclick="filterCat('all', this)"><i class="fas fa-th"></i><span>Todos</span></div>
    <div class="cat-card" onclick="filterCat('lengua', this)"><i class="fas fa-spell-check"></i><span>Lengua</span></div>
    <div class="cat-card" onclick="filterCat('matematica', this)"><i class="fas fa-calculator"></i><span>Mate</span></div>
    <div class="cat-card" onclick="filterCat('ciencias', this)"><i class="fas fa-flask"></i><span>Ciencias</span></div>
    <div class="cat-card" onclick="filterCat('otros', this)"><i class="fas fa-plus"></i><span>Otros</span></div>
  </div>

  <div class="filters-wrapper">
    <input type="text" id="search" class="search-box" placeholder="Buscar por nombre del libro..." oninput="render()">
  </div>

  <div class="grid" id="productGrid"></div>
</div>

<div id="cartBar" class="cart-summary">
  <h3 style="margin-top:0; font-size:1rem; color:var(--verde-oscuro)">Tu Pedido</h3>
  <ul id="cartList" class="cart-list"></ul>
  
  <div class="coupon-box">
    <input type="text" id="couponInput" placeholder="C√≥digo de cup√≥n">
    <button class="btn-coupon" onclick="applyCoupon()">Aplicar</button>
  </div>

  <div class="payment-methods">
      <h4><i class="fas fa-credit-card"></i> M√©todo de Pago:</h4>
      <div class="methods-grid">
          <div class="method-opt" onclick="selectPayment('Efectivo', this)">Efectivo</div>
          <div class="method-opt" onclick="selectPayment('Transferencia', this)">Transferencia</div>
          <div class="method-opt" onclick="selectPayment('Mercado Pago', this)">Mercado Pago</div>
          <div class="method-opt" onclick="selectPayment('Tarjeta', this)">Tarjeta Cr√©d/D√©b</div>
      </div>
  </div>

  <div style="background:#f9f9f9; padding:15px; border-radius:15px; margin-bottom:15px;">
    <div style="display:flex; justify-content: space-between; font-size: 0.9rem; margin-bottom:5px;">
        <span>Subtotal:</span> <span id="cartSubtotal">$0</span>
    </div>
    <div id="discountRow" style="display:none; justify-content: space-between; color: var(--rojo); font-weight: 700; font-size: 0.9rem;">
        <span id="discountLabel">Descuento:</span> <span id="cartDiscount">-$0</span>
    </div>
    <div style="display:flex; justify-content: space-between; align-items: center; margin-top: 10px; border-top:1px solid #ddd; pt:10px;">
        <span style="font-weight: 700;">TOTAL:</span>
        <span id="cartTotal" style="font-size:1.4rem; font-weight:700; color:var(--verde-oscuro)">$0</span>
    </div>
  </div>

  <div style="display:flex; gap:10px;">
    <button onclick="vaciarCarrito()" style="flex:1; padding:15px; border:none; border-radius:12px; cursor:pointer; font-weight:600; background:#eee;">Vaciar</button>
    <button onclick="sendOrder()" style="flex:2; background:var(--verde-whatsapp); color:white; border:none; border-radius:12px; font-weight:700; cursor:pointer; font-size:1rem;">
        <i class="fab fa-whatsapp"></i> Finalizar Pedido
    </button>
  </div>
</div>

<a href="https://wa.me/3516062227" class="whatsapp-float" target="_blank"><i class="fab fa-whatsapp"></i></a>

<script>
  // CONFIGURACI√ìN SUPABASE
  const SUPABASE_URL = "https://xlwkzoapfbpoxaccvoea.supabase.co";
  const SUPABASE_KEY = "sb_publishable_knGPyLLlMsy-YCQIblQnbQ_nrC8rV6x";
  const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  // CONFIGURACI√ìN CLOUDINARY
  const CLOUDINARY_URL = "https://api.cloudinary.com/v1_1/dllm8ggob/image/upload";
  const UPLOAD_PRESET = "Matita_web";

  let products = [];
  let favorites = JSON.parse(localStorage.getItem('favoritos_matita')) || [];
  let cart = [];
  let currentCat = 'all';
  let appliedCoupon = null;
  let paymentMethod = "";

  const configMatita = { montoMinimo: 50000, regaloPesos: 5000 };

  async function loadProducts() {
    const { data, error } = await _supabase
      .from('productos')
      .select('*');
    
    if (error) {
      console.error("Error cargando productos:", error);
    } else {
      products = data;
      render();
    }
  }

  // --- L√ìGICA DE SUBIDA SILENCIOSA ---
  async function handleFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      const status = document.getElementById('uploadStatus');
      status.style.color = "var(--verde-oscuro)";
      status.innerText = "‚è≥ Subiendo foto optimizada...";

      const formData = new FormData();
      formData.append('file', file);
      formData.append('upload_preset', UPLOAD_PRESET);
      // Aplicar f_auto y q_auto mediante par√°metros de subida
      formData.append('transformation', 'f_auto,q_auto');

      try {
          const resp = await fetch(CLOUDINARY_URL, { method: 'POST', body: formData });
          const data = await resp.json();

          if (data.secure_url) {
              status.innerText = "‚úÖ Subida con √©xito. Guardando en Supabase...";
              // Guardamos en Supabase
              await saveProductToSupabase(data.secure_url);
          }
      } catch (err) {
          status.innerText = "‚ùå Error al subir imagen.";
          console.error(err);
      }
  }

  async function saveProductToSupabase(url) {
      const { error } = await _supabase
          .from('productos')
          .insert([{ 
              nombre: "Nuevo Libro " + Math.floor(Math.random()*100), 
              precio: 1000, 
              imagen: url, 
              categoria: "otros",
              stock: "si"
          }]);

      if (error) {
          alert("Error Supabase: " + error.message);
      } else {
          document.getElementById('uploadStatus').innerText = "‚úÖ ¬°Producto creado con √©xito!";
          loadProducts(); // Refrescar lista
      }
  }
  // ---------------------------------

  function renderPromoBanner() {
      const banner = document.getElementById('promoBanner');
      banner.innerText = `üéÅ ¬°Si super√°s los $${Number(configMatita.montoMinimo).toLocaleString('es-AR')} te regalamos $${Number(configMatita.regaloPesos).toLocaleString('es-AR')}!`;
  }

  function render() {
    const grid = document.getElementById('productGrid');
    const search = document.getElementById('search').value.toLowerCase();
    grid.innerHTML = '';
    
    products.filter(p => {
      const matchesSearch = p.nombre.toLowerCase().includes(search);
      const matchesCat = (currentCat === 'all' || p.categoria === currentCat);
      return matchesSearch && matchesCat;
    }).forEach(p => {
      const isFav = favorites.includes(p.nombre) ? 'active' : '';
      const isAgotado = p.stock === 'no';
      
      // OPTIMIZACI√ìN DE IMAGEN CLOUDINARY AL RENDERIZAR
      const optimizedImg = p.imagen.replace('/upload/', '/upload/f_auto,q_auto/');

      let htmlPrecio = `<p class="price">$${Number(p.precio).toLocaleString('es-AR')}</p>`;
      if (p.precioAnterior) {
          htmlPrecio = `<span class="old-price">$${Number(p.precioAnterior).toLocaleString('es-AR')}</span>` + `<p class="price price-promo">$${Number(p.precio).toLocaleString('es-AR')}</p>`;
      }

      grid.innerHTML += `
        <div class="product-card" style="${isAgotado ? 'opacity:0.7' : ''}">
          <div class="img-container">
            ${p.etiqueta && p.etiqueta !== 'ninguna' ? `<div class="badge-promo">${p.etiqueta}</div>` : ''}
            <button class="fav-btn ${isFav}" onclick="toggleFav('${p.nombre}')"><i class="fas fa-heart"></i></button>
            <img src="${optimizedImg}" onerror="this.src='https://via.placeholder.com/300'">
          </div>
          <div class="info">
            <small style="color:var(--dorado); font-weight:700">${p.categoria.toUpperCase()}</small>
            <h3 style="margin:10px 0; font-size:1.1rem; min-height:45px">${p.nombre}</h3>
            <div class="price-container">${htmlPrecio}</div>
            <button class="btn-add" ${isAgotado ? 'disabled style="background:#ccc"' : ''} onclick="addToCart('${p.nombre}', ${p.precio})">
              ${isAgotado ? 'SIN STOCK' : 'AGREGAR AL CARRITO'}
            </button>
          </div>
        </div>`;
    });
  }

  function selectPayment(method, element) {
      paymentMethod = method;
      document.querySelectorAll('.method-opt').forEach(opt => opt.classList.remove('selected'));
      element.classList.add('selected');
  }

  function toggleFav(name) {
    favorites = favorites.includes(name) ? favorites.filter(f => f !== name) : [...favorites, name];
    localStorage.setItem('favoritos_matita', JSON.stringify(favorites));
    render();
  }

  function addToCart(name, price) {
    cart.push({name, price});
    updateCartUI();
  }

  async function applyCoupon() {
    const codeInput = document.getElementById('couponInput').value.trim().toUpperCase();
    
    const { data: found, error } = await _supabase
      .from('cupones')
      .select('*')
      .eq('codigo', codeInput)
      .single();
    
    if(found && !error) {
        appliedCoupon = found;
        alert(`¬°Cup√≥n ${found.codigo} aplicado!`);
    } else {
        appliedCoupon = null;
        alert("Cup√≥n no v√°lido.");
    }
    updateCartUI();
  }

  function updateCartUI() {
    const bar = document.getElementById('cartBar');
    bar.classList.toggle('active', cart.length > 0);
    
    const cartList = document.getElementById('cartList');
    cartList.innerHTML = cart.map((item, index) => `
        <li class="cart-item">
            <span>${item.name}</span>
            <div>
                <strong>$${Number(item.price).toLocaleString('es-AR')}</strong>
                <i class="fas fa-times" onclick="removeItem(${index})" style="margin-left:10px; color:var(--rojo); cursor:pointer"></i>
            </div>
        </li>
    `).join('');

    let subtotal = cart.reduce((acc, item) => acc + Number(item.price), 0);
    let regalo = (subtotal >= Number(configMatita.montoMinimo)) ? Number(configMatita.regaloPesos) : 0;
    let descuentoCupon = appliedCoupon ? subtotal * (Number(appliedCoupon.descuento) / 100) : 0;
    let totalFinal = subtotal - (regalo + descuentoCupon);
    
    document.getElementById('cartSubtotal').innerText = `$${subtotal.toLocaleString('es-AR')}`;
    
    if(regalo + descuentoCupon > 0) {
        document.getElementById('discountRow').style.display = 'flex';
        document.getElementById('cartDiscount').innerText = `-$${(regalo + descuentoCupon).toLocaleString('es-AR')}`;
    } else {
        document.getElementById('discountRow').style.display = 'none';
    }

    document.getElementById('cartTotal').innerText = `$${(totalFinal < 0 ? 0 : totalFinal).toLocaleString('es-AR')}`;
  }

  function removeItem(index) {
      cart.splice(index, 1);
      updateCartUI();
  }

  async function sendOrder() {
    if(!paymentMethod) return alert("Por favor, seleccion√° un m√©todo de pago.");

    let subtotal = cart.reduce((acc, item) => acc + Number(item.price), 0);
    let regalo = (subtotal >= Number(configMatita.montoMinimo)) ? Number(configMatita.regaloPesos) : 0;
    let descuentoCupon = appliedCoupon ? (subtotal * (Number(appliedCoupon.descuento) / 100)) : 0;
    let totalFinal = subtotal - (regalo + descuentoCupon);

    let text = "*NUEVO PEDIDO - LIBRER√çA MATITA*%0A%0A";
    text += cart.map(i => "- " + i.name).join("%0A");
    text += `%0A%0A*Subtotal:* $${subtotal.toLocaleString('es-AR')}`;
    if(regalo > 0) text += `%0AüéÅ *Regalo:* -$${regalo.toLocaleString('es-AR')}`;
    if(appliedCoupon) text += `%0Aüé´ *Cup√≥n:* -$${descuentoCupon.toLocaleString('es-AR')}`;
    text += `%0Aüí∞ *M√©todo de Pago:* ${paymentMethod}`;
    text += `%0A%0A*TOTAL FINAL: $${(totalFinal < 0 ? 0 : totalFinal).toLocaleString('es-AR')}*`;
    
    await _supabase.from('pedidos').insert([{
        detalle: cart.map(i => i.name).join(", "),
        pago: paymentMethod,
        total: totalFinal
    }]);

    window.open(`https://wa.me/3516062227?text=${text}`, '_blank');
  }

  function filterCat(cat, btn) {
    currentCat = cat;
    document.querySelectorAll('.cat-card').forEach(c => c.classList.remove('active'));
    btn.classList.add('active');
    render();
  }

  function vaciarCarrito() { cart = []; appliedCoupon = null; paymentMethod = ""; document.querySelectorAll('.method-opt').forEach(opt => opt.classList.remove('selected')); updateCartUI(); }

  window.onload = () => { renderPromoBanner(); loadProducts(); };
</script>
</body>
</html>
